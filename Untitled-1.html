<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hangszer Vad√°szat</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video, canvas { margin: 10px auto; display: block; }
    #result { font-size: 20px; color: green; margin-top: 20px; }
    #captureBtn { font-size: 16px; padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>üé∫ Tal√°ld meg a hangszert! V4</h1>
  <video id="video" width="320" height="240" autoplay muted></video>
  <button id="captureBtn" disabled>K√©p k√©sz√≠t√©s √©s felismer√©s</button>
  <p id="result">V√°rakoz√°s a kamer√°ra‚Ä¶</p>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <!-- Template k√©pek (mindegyiket l√°thatatlann√° tessz√ºk) -->
  <img id="templateCiterakicsi"  src="citeraKicsi.png"  style="visibility:hidden;">
  <img id="templateCiterakicsi1" src="citeraKicsi1.png" style="visibility:hidden;">
  <img id="templateCiterakicsi2" src="citeraKicsi2.png" style="visibility:hidden;">
  <img id="templateCiteranagy"   src="citeraNagy.png"  style="visibility:hidden;">
  <img id="templateCiteranagy1"  src="citeraNagy1.png" style="visibility:hidden;">
  <img id="templateCiteranagy2"  src="citeraNagy2.png" style="visibility:hidden;">
  <img id="templateCiteranagy3"  src="citeraNagy3.png" style="visibility:hidden;">
  <img id="templateCiteranagy4"  src="citeraNagy4.png" style="visibility:hidden;">
  <img id="templateGitar"        src="gitar.png"       style="visibility:hidden;">
  <img id="templateHarmonika"    src="harmonika.png"   style="visibility:hidden;">
  <img id="templateHarmonika1"   src="harmonika1.png"  style="visibility:hidden;">
  <img id="templateHarmonika2"   src="harmonika2.png"  style="visibility:hidden;">
  <img id="templateKurt"         src="kurt.png"        style="visibility:hidden;">
  <img id="templateKurt1"        src="kurt1.png"       style="visibility:hidden;">
  <img id="templateKurt2"        src="kurt2.png"       style="visibility:hidden;">


  <!-- OpenCV.js bet√∂lt√©se -->
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>

  <!-- Saj√°t scriptjeink -->
  <script>
    // 1) OpenCV callback
    cv['onRuntimeInitialized'] = () => {
      initCameraAndUI();
    };

    // Glob√°lis v√°ltoz√≥k
    let video, canvas, context, result, captureBtn;
    const sablonok = [];

    // 2) Kamera inicializ√°ci√≥ + gomb bekapcsol√°sa
    function initCameraAndUI() {
      video      = document.getElementById('video');
      canvas     = document.getElementById('canvas');
      context    = canvas.getContext('2d');
      result     = document.getElementById('result');
      captureBtn = document.getElementById('captureBtn');

      // sablonok felt√∂lt√©se
      const ids = [
        'templateCiterakicsi','templateCiterakicsi1','templateCiterakicsi2',
        'templateCiteranagy','templateCiteranagy1','templateCiteranagy2',
        'templateCiteranagy3','templateCiteranagy4',
        'templateGitar',
        'templateHarmonika','templateHarmonika1','templateHarmonika2',
        'templateKurt','templateKurt1','templateKurt2'
      ];
      for (let id of ids) {
        const el = document.getElementById(id);
        if (el) sablonok.push(el);
      }

      // kamer√°hoz jut√°s
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          captureBtn.disabled = false;
          captureBtn.addEventListener('click', captureAndMatch);
          result.textContent = 'Kamera k√©szen, kattints a gombra!';
        })
        .catch(err => {
          console.error(err);
          result.textContent = 'Nem siker√ºlt el√©rni a kamer√°t.';
        });
    }

    // 3) Capture & match
    async function captureAndMatch() {
      captureBtn.style.display = 'none';
      result.textContent = '‚è≥ Feldolgoz√°s‚Ä¶';

      const t0 = performance.now();
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // k√©p el≈ëk√©sz√≠t√©se
      let src = cv.imread(canvas);
      cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(src, src, new cv.Size(5,5), 0);

      let best = { nev: '', pont: 0 };

      // v√©gigm√©rj√ºk a sablonokat
      for (let el of sablonok) {
        let tpl = cv.imread(el);
        if (!tpl || tpl.empty()) { tpl.delete?.(); continue; }

        cv.cvtColor(tpl, tpl, cv.COLOR_RGBA2GRAY);
        cv.GaussianBlur(tpl, tpl, new cv.Size(5,5), 0);

        let dst = new cv.Mat();
        cv.matchTemplate(src, tpl, dst, cv.TM_CCOEFF_NORMED);
        const { maxVal } = cv.minMaxLoc(dst);

        if (maxVal > 0.5 && maxVal > best.pont) {
          best = { nev: el.id.replace('template',''), pont: maxVal };
        }

        tpl.delete(); dst.delete();
      }
      src.delete();

      const dt = Math.round(performance.now() - t0);
      if (best.nev) {
        result.innerHTML = `‚úÖ Megtal√°lt: <b>${best.nev}</b><br>Egyez√©s: ${(best.pont*100).toFixed(1)}%<br>‚è±Ô∏è ${dt} ms`;
      } else {
        result.innerHTML = `‚ùå Nem tal√°lhat√≥ ismert hangszer.<br>‚è±Ô∏è ${dt} ms`;
      }

      captureBtn.style.display = 'inline-block';
    }
  </script>
</body>
</html>
